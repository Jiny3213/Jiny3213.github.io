<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>使用uniapp在微信小程序中压缩图片的几种方法及其优缺点 | Jiny3213的个人博客</title><script src="https://cdn.bootcss.com/valine/1.4.4/Valine.min.js"></script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 5.1.1"></head><body><header><nav><a href="/">Home</a><a href="/about/">About</a><a href="/archives/">Archives</a></nav></header><main><article><div id="post-bg"><div id="post-title"><div id="post-info"><span>date:<time datetime="2020-09-30T06:05:48.000Z" id="date"> 2020-09-30</time></span><br><span>updated:<time datetime="2020-10-19T04:53:56.610Z" id="updated"> 2020-10-19</time></span></div><h1>使用uniapp在微信小程序中压缩图片的几种方法及其优缺点</h1><hr></div><div id="post-content"><h2 id="问题产生的背景"><a href="#问题产生的背景" class="headerlink" title="问题产生的背景"></a>问题产生的背景</h2><p>需要用微信小程序收集用户的单据, 需要把图片转换为base64发送到服务器保存, 而且base64大小限制在512kb以下</p>
<h2 id="方法一-通过chooseImage压缩图片"><a href="#方法一-通过chooseImage压缩图片" class="headerlink" title="方法一 通过chooseImage压缩图片"></a>方法一 通过chooseImage压缩图片</h2><p>使用原生api, 在用户选择图片的过程中压缩, 通过去掉’original’选项强制用户选择压缩的图片, 而不允许选择原图</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plain">wx.chooseImage(&#123;<br>  sizeType: [&#39;compressed&#39;],<br>  success: res &#x3D;&gt; &#123;<br>  &#x2F;&#x2F; ...<br>  &#125;   <br>&#125;)<br></code></pre></td></tr></table></figure>

<p>使用uniapp封装的api, <a target="_blank" rel="noopener" href="https://uniapp.dcloud.io/api/README?id=promise-%E5%B0%81%E8%A3%85">uniapp为大部分api封装了promise</a>, 通过then返回一个数组, 分别为错误对象和原始返回数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs plain">uni.chooseImage(&#123;<br>  sizeType: [&#39;compressed&#39;],<br>&#125;).then(data &#x3D;&gt; &#123;<br>  let [err, res] &#x3D; data<br>  &#x2F;&#x2F; ...<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>这种方式虽然可以大大减少图片的体积到可用的范围, 常规图片可以压缩到70kb左右, 但图片严重失真, 用户的单据中的文字都无法看清, 不满足需求</p>
<h2 id="方法二-使用canvas压缩图片"><a href="#方法二-使用canvas压缩图片" class="headerlink" title="方法二 使用canvas压缩图片"></a>方法二 使用canvas压缩图片</h2><p>在web端经常使用canvas来对图片进行裁剪, 压缩和转换, 但在小程序上有较多的限制, 渲染速度也会降低</p>
<h3 id="template"><a href="#template" class="headerlink" title="template"></a>template</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs plain">&lt;canvas canvas-id&#x3D;&#39;canvas&#39; <br>        id&#x3D;&quot;canvas&quot;<br>        :style&#x3D;&quot;&#123;width: canvasWidth + &#39;px&#39;, height: canvasHeight + &#39;px&#39;&#125;&quot;<br>        &gt;&lt;&#x2F;canvas&gt;<br></code></pre></td></tr></table></figure>

<ul>
<li>canvas-id 用于js获取canvas对象</li>
<li>style 通过内联样式动态改变canvas的宽高</li>
<li>在canvas外层罩一个view, 定位到屏幕外, 这样渲染的时候就不会被用户看到了</li>
</ul>
<h3 id="javascript"><a href="#javascript" class="headerlink" title="javascript"></a>javascript</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs plain">data() &#123;<br>    return &#123;<br>        tmpFileList: [] &#x2F;&#x2F; 保存图片临时链接<br>    &#125;<br>&#125;<br>methods: &#123;<br>    &#x2F;&#x2F; 封装转换base64图片的方法<br>    filePathToBase64(filePath) &#123;<br>      let base64 &#x3D; wx.getFileSystemManager().readFileSync(filePath, &#39;base64&#39;)<br>      let beforeStr &#x3D; &#39;data:image&#x2F;jpeg;base64,&#39;<br>      return beforeStr + base64<br>    &#125;,<br>    async chooseImage() &#123;<br>        let size &#x2F;&#x2F; 当前图片大小<br>        let tmpFile &#x2F;&#x2F; 压缩后的图片临时链接<br>    <br>        &#x2F;&#x2F; 选择图片<br>        await uni.chooseImage(&#123;<br>          count: 1,<br>          sizeType: [&#39;original&#39;], &#x2F;&#x2F; 只允许上传原图<br>        &#125;).then(e &#x3D;&gt; &#123;<br>          e &#x3D; e[1] &#x2F;&#x2F; 解开 uniapp 的封装<br>          this.tmpFileList &#x3D; this.tmpFileList.concat(e.tempFilePaths)<br>          tmpFile &#x3D; e.tempFilePaths[0]<br>          size &#x3D; this.filePathToBase64(this.tmpFileList[0]).length<br>        &#125;)<br>        <br>        &#x2F;&#x2F; 获取图片长宽, 并改变canvas的大小<br>        await uni.getImageInfo(&#123;<br>          src: this.tmpFileList[0],<br>        &#125;).then(res &#x3D;&gt; &#123;<br>          this.canvasWidth &#x3D; res[1].width<br>          this.canvasHeight &#x3D; res[1].height<br>        &#125;)<br>        <br>        &#x2F;&#x2F; 把图片渲染到canvas<br>        const ctx &#x3D; uni.createCanvasContext(&#39;canvas&#39;, this)<br>        ctx.drawImage(this.tmpFileList[0], 0, 0, this.canvasWidth, this.canvasHeight)<br>        await new Promise(resolve &#x3D;&gt; &#123;<br>          ctx.draw(false, () &#x3D;&gt; resolve())<br>        &#125;) &#x2F;&#x2F; 尽管在这里等待了回调, 在手机上还是不一定渲染完, 直接进行下一步有可能得到图片的左上角<br>    <br>        &#x2F;&#x2F; 等待渲染完成, 循环压缩图片指导符合尺寸要求<br>        setTimeout(async () &#x3D;&gt; &#123;<br>          let compressTime &#x3D; 0<br>          const compressQualitys &#x3D; [<br>            0.5, 0.4, 0.3, 0.2, 0.1, 0.05, 0.03, 0.02, 0.01, 0.005<br>          ]<br>          while(size &gt; 512000 &amp;&amp; compressTime &lt; 9) &#123;<br>            await wx.canvasToTempFilePath(&#123;<br>              canvasId: &#39;canvas&#39;,<br>              quality: compressQualitys[compressTime],<br>              fileType: &#39;jpg&#39;,<br>            &#125;, this)<br>            .then(res &#x3D;&gt; &#123;<br>              console.log(res.tempFilePath)<br>              tmpFile &#x3D; res.tempFilePath<br>              size &#x3D; this.filePathToBase64(res.tempFilePath).length<br>            &#125;)<br>            compressTime++<br>          &#125;<br>          this.tmpFileList.push(tmpFile)<br>        &#125;, 500) <br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>然而这个方法还是存在问题</p>
<ul>
<li>循环压缩非常消耗手机性能, 如果压缩10次的话要花费大量的时间</li>
<li>即使压缩了10次, 太大的图片还是不能符合大小要求, 而且图片会严重失真</li>
</ul>
<h2 id="方法三-通过compressImage压缩图片"><a href="#方法三-通过compressImage压缩图片" class="headerlink" title="方法三 通过compressImage压缩图片"></a>方法三 通过compressImage压缩图片</h2><p>小程序为我们提供了compressImage的api来压缩图片，其性能比canvas渲染压缩更快，用户等待时间少</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs plain">async function compressImage(imagePath, targetSize&#x3D;512) &#123;<br>  let currentBase64 &#x3D; filePathToBase64(imagePath)<br>  let repeatTime &#x3D; 0 &#x2F;&#x2F; 重复压缩次数<br>  let compressedPath &#x3D; imagePath &#x2F;&#x2F; 压缩后的图片文件路径<br>  while (currentBase64.length &#x2F; 1024 &gt; targetSize) &#123;<br>    await uni.compressImage(&#123;<br>      src: imagePath,<br>      quality: 50 - 5 * repeatTime,<br>    &#125;)<br>    .then(res &#x3D;&gt; &#123;<br>      let [err, data] &#x3D; res<br>      currentBase64 &#x3D; filePathToBase64(data.tempFilePath)<br>      compressedPath &#x3D; data.tempFilePath<br>      console.log(&#96;压缩第$&#123;repeatTime + 1&#125;次, 压缩质量为$&#123;50 - 5 * repeatTime&#125;%,压缩后大小为: $&#123;currentBase64.length&#125;&#96;)<br>          &#125;)<br>    if(repeatTime &gt;&#x3D; 9) &#123;<br>      console.log(&#39;循环次数过多, 强制停止压缩&#39;)<br>      break<br>    &#125;<br>    repeatTime++<br>  &#125;<br>  console.log(&#96;压缩完成, 当前大小为$&#123;currentBase64.length&#125;&#96;)<br>  return &#123;imagePath: compressedPath, base64: currentBase64&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个方法的缺点是，在压缩的过程中会保存临时图片到本地相册，如果压缩了10次就会保存10张临时图片，用户会在相册中看到一大堆重复的图片，严重影响用户体验</p>
<p>但在用户手机上保存临时图片不加限制也不作清理，我觉得这个更多的是微信的锅</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在小程序上进行前端的图片压缩有各方面的限制和缺点，不要期待小程序对图片压缩的能力，这种事情还是交给后端吧</p>
<div id="paginator"></div></div><div id="post-footer"><hr><a href="/2020/10/10/uniapp-reactive/">← Prev 在uniapp中完善vue的响应式</a><span style="color: #fe2"> | </span><a href="/2020/09/25/learn-git-8-fix-history/">重新认识git【九】改变历史提交 Next →</a><hr></div><div id="bottom-btn"><a id="to-index" href="#post-index" title="index">≡</a><a id="to-top" href="#post-title" title="to top">∧</a></div><div id="Valine"></div><script>new Valine({
 el: '#Valine'
 , appId: ''
 , appKey: ''
 , placeholder: '此条评论委托企鹅物流发送'
})</script></div></article><aside><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><h1 id="Dr"><a href="/"> Dr.Jiny</a></h1><section id="total"><a id="total-archives" href="/archives"><span class="total-title">Archives Total:</span><span class="total-number">19</span></a><div id="total-tags"><span class="total-title">Tags:</span><span class="total-number">4</span></div><div id="total-categories"><span class="total-title">Categories:</span><span class="total-number">1</span></div></section></div><div id="aside-block"><h1>INDEX</h1><div id="post-index"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E4%BA%A7%E7%94%9F%E7%9A%84%E8%83%8C%E6%99%AF"><span class="toc-number">1.</span> <span class="toc-text">问题产生的背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80-%E9%80%9A%E8%BF%87chooseImage%E5%8E%8B%E7%BC%A9%E5%9B%BE%E7%89%87"><span class="toc-number">2.</span> <span class="toc-text">方法一 通过chooseImage压缩图片</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C-%E4%BD%BF%E7%94%A8canvas%E5%8E%8B%E7%BC%A9%E5%9B%BE%E7%89%87"><span class="toc-number">3.</span> <span class="toc-text">方法二 使用canvas压缩图片</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#template"><span class="toc-number">3.1.</span> <span class="toc-text">template</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#javascript"><span class="toc-number">3.2.</span> <span class="toc-text">javascript</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%89-%E9%80%9A%E8%BF%87compressImage%E5%8E%8B%E7%BC%A9%E5%9B%BE%E7%89%87"><span class="toc-number">4.</span> <span class="toc-text">方法三 通过compressImage压缩图片</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol></div></div><footer><nobr><span class="text-title">©</span><span class="text-content">1970 to 2020</span></nobr><wbr><nobr><span class="text-title">ICP</span><span class="text-content">——备案号——</span></nobr><wbr><wbr><nobr>published with&nbsp;<a target="_blank" rel="noopener" href="http://hexo.io">Hexo&nbsp;</a></nobr><wbr><nobr>Theme&nbsp;<a target="_blank" rel="noopener" href="https://github.com/Yue-plus/hexo-theme-arknights">Arknight&nbsp;</a></nobr><wbr><nobr>by&nbsp;<a target="_blank" rel="noopener" href="https://github.com/Yue-plus">Yue_plus</a></nobr></footer></aside></main><canvas id="canvas-dust"></canvas><script src="/js/arknights.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script></body></html>